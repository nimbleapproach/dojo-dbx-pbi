# Databricks notebook source
# MAGIC %md
# MAGIC #Notebook to create views 

# COMMAND ----------

# MAGIC %sql
# MAGIC CREATE WIDGET TEXT core_catalog DEFAULT "coreprod";
# MAGIC CREATE WIDGET TEXT catalog DEFAULT "";
# MAGIC CREATE WIDGET TEXT schema DEFAULT "";
# MAGIC CREATE WIDGET TEXT view_name DEFAULT "vw_store_details";
# MAGIC

# COMMAND ----------

# MAGIC %md
# MAGIC ###Copy widgets into local variables
# MAGIC Databricks has a bug clearing widgets values on a change. 
# MAGIC Following command is copying wdgets values into the local variable and removing widgets. 
# MAGIC

# COMMAND ----------

spark.conf.set ('widget.core_catalog', dbutils.widgets.get("core_catalog"))
spark.conf.set ('widget.catalog', dbutils.widgets.get("catalog"))
spark.conf.set ('widget.schema', dbutils.widgets.get("schema"))
spark.conf.set ('widget.view_name', dbutils.widgets.get("view_name"))


#Reset the widgets values to avoid any caching issues. 
dbutils.widgets.text('core_catalog', "")
dbutils.widgets.text('catalog', "")
dbutils.widgets.text('schema', "")
dbutils.widgets.text('view_name', "")
dbutils.widgets.removeAll()

# COMMAND ----------

# MAGIC %sql
# MAGIC SELECT '${widget.core_catalog}' AS core_catalog,
# MAGIC        '${widget.catalog}' AS catalog,
# MAGIC        '${widget.schema}' AS schema,
# MAGIC        '${widget.view_name}' AS view_name;

# COMMAND ----------

# MAGIC %sql
# MAGIC CREATE OR REPLACE VIEW ${widget.catalog}.${widget.schema}.${widget.view_name}
# MAGIC AS
# MAGIC select * from(
# MAGIC select store_nbr,
# MAGIC     CASE WHEN STORE_NBR IN (4391,4378,4627,4513,4600,4430,4281,4148,4276,4327,4670,4164,4251,4881,4564,4209,4524) THEN 'SOUTH WALES'
# MAGIC     WHEN STORE_NBR IN (4379,4614,4917,4581,5123,4647,4183,4771,4777,5830,4345,4991,4996,4271,4958,4942,4195,4994) THEN 'BRISTOL'
# MAGIC     WHEN STORE_NBR IN (4376,4274,4523,4602,4801,4454,4466,4231,4187,5881,4964,4660,4641,5757,5880,4667,4138) THEN 'CENTRAL MIDLANDS'
# MAGIC     WHEN STORE_NBR IN (4967,4672,4894,4747,4214,4159,4599,4669,4177,4786,5840,4583,4986,4616,4188,4924) THEN 'SOUTH COAST'
# MAGIC     WHEN STORE_NBR IN (4644,4857,4470,4218,4501,4681,4156,4644,5729,4617,4383,4278,4989,4575,4500,4778) THEN 'ANGLIA'
# MAGIC     WHEN STORE_NBR IN (4657,5865,4699,4597,4945,4676,4225,4977,4170,4754,4753,4464,4759,4765,4453,4653,4423,5130,4229,4953,5600) THEN 'BIRMINGHAM'
# MAGIC     WHEN STORE_NBR IN (4941,4352,4907,4876,4749,4901,4515,4634,4596,4688,4618,4623,4622,4655,5871,4563,4691) THEN 'CENTRAL LONDON'
# MAGIC     WHEN STORE_NBR IN (4283,4176,4203,4522,4911,4185,4171,4131,4969,5868,4375,5895,4238,4980,4651,4318) THEN 'CENTRAL SCOTLAND'
# MAGIC     WHEN STORE_NBR IN (4576,5885,5819,4540,4485,4519,4508,4329,4506,4386,4620,4227,4374,4764,4509,4675,4963) THEN 'CENTRAL YORKSHIRE'
# MAGIC     WHEN STORE_NBR IN (4811,4357,4750,4865,4479,5892,4631,4165,4436,4566,4798,4567,4201,4979,4981,5719,4654,4463) THEN 'EAST MIDLANDS'
# MAGIC     WHEN STORE_NBR IN (4625,4664,4440,4879,4307,5784,4926,5876,4344,4648,5870,4960,4965) THEN 'EAST SCOTLAND'
# MAGIC     WHEN STORE_NBR IN (4816,4628,4486,4460,4548,4543,4723,4743,4456,4712,4181,4146,4954,4630,4126,4245,4135,4174,4689) THEN 'EAST YORKSHIRE'
# MAGIC     WHEN STORE_NBR IN (4471,4409,4467,4905,4697,4182,4685,4220,4338,4776,4825,4646,4931,4792,4916) THEN 'KENT & SUSSEX'
# MAGIC     WHEN STORE_NBR IN (4611,4488,4550,4740,4726,4557,4127,4244,4196,4652,4585,4997,4136,4139,4936,4995,4626,4922) THEN 'LANCASHIRE'
# MAGIC     WHEN STORE_NBR IN (4492,4735,4727,4715,4562,4489,4718,4633,4144,4940,4169,4194,4640,4364,4668,4948,5759,4943,4608,4636,5883,4394,5014) THEN 'LANCASHIRE & LAKES'
# MAGIC     WHEN STORE_NBR IN (5864,4797,4551,4736,4491,4645,4929,5818,4643,4145,4361,5849,4933,4973,4259,4580,4944,4561) THEN 'LIVERPOOL'
# MAGIC     WHEN STORE_NBR IN (4606,4216,4752,4469,4462,4535,4161,4189,4263,4184,5761,4766,4806,4140,5866,5794,4783) THEN 'NORTH LONDON & ESSEX'
# MAGIC     WHEN STORE_NBR IN (4224,4314,4584,4565,4725,4700,4706,4490,4734,4487,4732,4162,4604,4601,4322,4527,4919,4155,4157) THEN 'NORTH MANCHESTER'
# MAGIC     WHEN STORE_NBR IN (4230,4780,4903,4607,4477,4533,4449,4473,4474,4915,4938,4342,4975,4666,4990,4571,4880) THEN 'NORTH MIDLANDS'
# MAGIC     WHEN STORE_NBR IN (4128,4249,4531,4172,4935,4405,4781,4260,4326,4175,4971,4927,4243,4637,4368,4370) THEN 'NORTH SCOTLAND'
# MAGIC     WHEN STORE_NBR IN (4372,4348,4133,4737,4711,4730,4738,5878,4605,4143,4510,4252,4253,5884,4739,4930,4841,4850) THEN 'NORTH WALES & CHESTER'
# MAGIC     WHEN STORE_NBR IN (4286,4337,4311,5004,4285,4288,4289,4316,4290,5899,4292,4363,4293,4294,4433,5900,4287) THEN 'NORTHERN IRELAND'
# MAGIC     WHEN STORE_NBR IN (4393,4266,4324,4745,4472,4609,4603,4693,4794,4153,4659,4570,4952,4511,4656) THEN 'SOUTH EAST LONDON'
# MAGIC     WHEN STORE_NBR IN (4346,4586,4211,4141,4837,4179,4928,4275,4662,4366,4410,4918,4598,4845,4273,4442,4799,4920,4415,4615,4925) THEN 'SOUTH EAST WALES & GLOUCESTER'
# MAGIC     WHEN STORE_NBR IN (4520,4787,4788,4704,4554,4702,5028,4137,4658,4579,4956,4840,4632,4210,4422,4877) THEN 'SOUTH MANCHESTER'
# MAGIC     WHEN STORE_NBR IN (4690,4582,4642,4396,4461,4892,4885,4751,4217,4663,4696,4635,4976,5758,4360,4619,4232) THEN 'SOUTH MIDLANDS'
# MAGIC     WHEN STORE_NBR IN (4684,4459,4538,4701,4555,4720,4457,4556,4539,4478,4458,4507,4544,4559,4505,4742,4186,4403,4769,4517,4476,4475,4966,4425) THEN 'SOUTH YORKSHIRE'
# MAGIC     WHEN STORE_NBR IN (4587,4950,4906,4610,4178,4789,4987,4988,5001,4638,4993,4692,4279,4549,4313,4320,4142,4731,4708,4744,4728,4710,4493) THEN 'TEESSIDE'
# MAGIC     WHEN STORE_NBR IN (4639,4680,4419,4934,5889,4149,5002,4955,4900,4333,4512,4733,4497,4716,4705,4537,4703,4741,4447,4499,4813,4424) THEN 'TYNESIDE'
# MAGIC     WHEN STORE_NBR IN (4961,4514,4408,4772,4399,4356,4574,5828,4677,4844,4325,5762,4804,4173,4152,4774,4671,4679) THEN 'WEST COUNTRY'
# MAGIC     WHEN STORE_NBR IN (5867,4873,4536,4443,4248,4167,4414,5810,4649,4932,4154,4851,5809,4163,4823,4518,4775) THEN 'WEST LONDON'
# MAGIC     WHEN STORE_NBR IN (4791,4351,4878,5134,4761,4757,4483,4452,4484,4450,4756,4758,4200,4694,4233,4613,5011,4572,4530,4168,4949,4190) THEN 'WEST MIDLANDS'
# MAGIC     WHEN STORE_NBR IN (4421,4308,5807,4826,5894,4674,4577,4264,4661,4923,4957,4686,4946,4192,4151,4678) THEN 'WEST SCOTLAND'
# MAGIC     WHEN STORE_NBR IN (4147,4160,5869,4939,4390,4280,4332,4808,4947,4494,4547,4760,4446,4504,4444,4709,4448,5013,4573,4158,4621) THEN 'WEST YORKSHIRE'
# MAGIC     ELSE 'n/a'
# MAGIC     END AS region
# MAGIC     -- ,store_nm
# MAGIC     ,split_part(min(store_nm), ' (', 1) as store_nm
# MAGIC     ,latitude
# MAGIC     ,longitude
# MAGIC from ${widget.core_catalog}.gb_customer_data_domain_odl.cdd_odl_dim_store
# MAGIC where store_nbr in 
# MAGIC (
# MAGIC 4391, 4378, 4627, 4513, 4600, 4430, 4281, 4148, 4276, 4327, 4670, 4164, 4251, 4881, 4564, 4209, 4524, 4379, 4614, 4917, 4581, 5123, 4647, 4183, 4771, 4777, 5830, 4345, 4991, 4996, 4271, 4958, 4942, 4195, 4994, 4376, 4274,4523, 4602, 4801, 4454, 4466, 4231, 4187, 5881, 4964, 4660, 4641, 5757, 5880, 4667, 4138, 4967, 4672, 4894, 4747, 4214, 4159, 4599, 4669, 4177, 4786, 5840, 4583, 4986, 4616, 4188, 4924, 4644, 4857, 4470, 4218, 4501, 4681,4156, 4644, 5729, 4617, 4383, 4278, 4989, 4575, 4500, 4778, 4657, 5865, 4699, 4597, 4945, 4676, 4225, 4977, 4170, 4754, 4753, 4464, 4759, 4765, 4453, 4653, 4423, 5130, 4229, 4953, 4941, 4352, 4907, 4876, 4749, 4901, 4515,4634, 4596, 4688, 4618, 4623, 4622, 4655, 5871, 4563, 4691, 4283, 4176, 4203, 4522, 4911, 4185, 4171, 4131, 4969, 5868, 4375, 5895, 4238, 4980, 4651, 4318, 4576, 5885, 5819, 4540, 4485, 4519, 4508, 4329, 4506, 4386, 4620,4227, 4374, 4764, 4509, 4675, 4963, 4811, 4357, 4750, 4865, 4479, 5892, 4631, 4165, 4436, 4566, 4798, 4567, 4201, 4979, 4981, 5719, 4654, 4463, 4625, 4664, 4440, 4879, 4307, 5784, 4926, 5876, 4344, 4648, 5870, 4960, 4965,4816, 4628, 4486, 4460, 4548, 4543, 4723, 4743, 4456, 4712, 4181, 4146, 4954, 4630, 4126, 4245, 4135, 4174, 4689, 4471, 4409, 4467, 4905, 4697, 4182, 4685, 4220, 4338, 4776, 4825, 4646, 4931, 4792, 4916, 4611, 4488, 4550,4740, 4726, 4557, 4127, 4244, 4196, 4652, 4585, 4997, 4136, 4139, 4936, 4995, 4626, 4922, 4492, 4735, 4727, 4715, 4562, 4489, 4718, 4633, 4144, 4940, 4169, 4194, 4640, 4364, 4668, 4948, 5759, 4943, 4608, 4636, 5883, 4394,5014, 5864, 4797, 4551, 4736, 4491, 4645, 4929, 5818, 4643, 4145, 4361, 5849, 4933, 4973, 4259, 4580, 4944, 4561, 4606, 4216, 4752, 4469, 4462, 4535, 4161, 4189, 4263, 4184, 5761, 4766, 4806, 4140, 5866, 5794, 4783, 4224,4314, 4584, 4565, 4725, 4700, 4706, 4490, 4734, 4487, 4732, 4162, 4604, 4601, 4322, 4527, 4919, 4155, 4157, 4230, 4780, 4903, 4607, 4477, 4533, 4449, 4473, 4474, 4915, 4938, 4342, 4975, 4666, 4990, 4571, 4880, 4128, 4249,4531, 4172, 4935, 4405, 4781, 4260, 4326, 4175, 4971, 4927, 4243, 4637, 4368, 4370, 4372, 4348, 4133, 4737, 4711, 4730, 4738, 5878, 4605, 4143, 4510, 4252, 4253, 5884, 4739, 4930, 4841, 4850, 4286, 4337, 4311, 5004, 4285,4288, 4289, 4316, 4290, 5899, 4292, 4363, 4293, 4294, 4433, 5900, 4287, 4393, 4266, 4324, 4745, 4472, 4609, 4603, 4693, 4794, 4153, 4659, 4570, 4952, 4511, 4656, 4346, 4586, 4211, 4141, 4837, 4179, 4928, 4275, 4662, 4366,4410, 4918, 4598, 4845, 4273, 4442, 4799, 4920, 4415, 4615, 4925, 4520, 4787, 4788, 4704, 4554, 4702, 5028, 4137, 4658, 4579, 4956, 4840, 4632, 4210, 4422, 4877, 4690, 4582, 4642, 4396, 4461, 4892, 4885, 4751, 4217, 4663,4696, 4635, 4976, 5758, 4360, 4619, 4232, 4684, 4459, 4538, 4701, 4555, 4720, 4457, 4556, 4539, 4478, 4458, 4507, 4544, 4559, 4505, 4742, 4186, 4403, 4769, 4517, 4476, 4475, 4966, 4425, 4587, 4950, 4906, 4610, 4178, 4789,4987, 4988, 5001, 4638, 4993, 4692, 4279, 4549, 4313, 4320, 4142, 4731, 4708, 4744, 4728, 4710, 4493, 4639, 4680, 4419, 4934, 5889, 4149, 5002, 4955, 4900, 4333, 4512, 4733, 4497, 4716, 4705, 4537, 4703, 4741, 4447, 4499,4813, 4424, 4961, 4514, 4408, 4772, 4399, 4356, 4574, 5828, 4677, 4844, 4325, 5762, 4804, 4173, 4152, 4774, 4671, 4679, 5867, 4873, 4536, 4443, 4248, 4167, 4414, 5810, 4649, 4932, 4154, 4851, 5809, 4163, 4823, 4518, 4775,4791, 4351, 4878, 5134, 4761, 4757, 4483, 4452, 4484, 4450, 4756, 4758, 4200, 4694, 4233, 4613, 5011, 4572, 4530, 4168, 4949, 4190, 4421, 4308, 5807, 4826, 5894, 4674, 4577, 4264, 4661, 4923, 4957, 4686, 4946, 4192, 4151,4678, 4147, 4160, 5869, 4939, 4390, 4280, 4332, 4808, 4947, 4494, 4547, 4760, 4446, 4504, 4444, 4709, 4448, 5013, 4573, 4158, 4621, 5600
# MAGIC )
# MAGIC and store_nm not like '%, %'
# MAGIC -- and store_nm not like '%(%'
# MAGIC group by store_nbr, latitude, longitude
# MAGIC order by store_nbr
# MAGIC
# MAGIC )
# MAGIC union
# MAGIC (
# MAGIC     select  store_nbr
# MAGIC         , 'CENTRAL LONDON' as regoin
# MAGIC         ,split_part(min(store_nm), ' (', 1) as store_nm
# MAGIC         ,latitude
# MAGIC         ,longitude 
# MAGIC     from(
# MAGIC         select *
# MAGIC         from ${widget.core_catalog}.gb_customer_data_domain_odl.cdd_odl_dim_store
# MAGIC         where (latitude is not null and store_nbr= '5601')
# MAGIC         limit 1
# MAGIC     )
# MAGIC     group by store_nbr
# MAGIC         ,latitude
# MAGIC         ,longitude
# MAGIC );
# MAGIC
# MAGIC
# MAGIC   --SELECT * FROM ${complete_view_name} LIMIT 10;
# MAGIC
# MAGIC
# MAGIC
